# Architecture Refinements v4.1

**Version**: 4.1.0
**Date**: 2025-11-18
**Status**: Architecture Update - Open-Source First + Privacy Mode + RAG Optimization
**Parent**: v4.0.0 (Multi-Agent Orchestrator)

---

## Executive Summary

**v4.1 refines the v4.0 architecture** with critical improvements focusing on:

1. **Open-Source LLM Leverage**: 80%+ execution on Tier 0/1, premium APIs only as architects/advisors
2. **Privacy Mode**: Local-only option excluding all external APIs (GDPR/HIPAA compliant)
3. **RAG Context Optimization**: Anti-hallucination through precise context management for Claude/Gemini
4. **Web Agent Privacy & Performance**: Unified Playwright architecture with privacy hardening
5. **Cost Transparency UI**: Real-time cost tracking with pre-prompt estimates

**Cost Target**: <$10/month for 100 tasks in privacy mode ($0 API costs + $75 VPS)
**Savings**: 84-88% vs naive all-Tier-3 routing ($6-8/month vs $50 baseline)

---

## Core Architectural Shifts

### 1. Open-Source First Strategy

**Problem**: Premium API costs ($3-15/M tokens) scale dangerously. Subscriptions affordable ($30/mo), but API usage can explode ($100s/mo).

**Solution**: Use open-source models (Tier 0/1) as primary workers. Premium models (Tier 3) ONLY as architects/advisors.

**Implementation**:

| Role | Tier | Model | Use Case | Cost |
|------|------|-------|----------|------|
| **Primary Worker** | Tier 0/1 | Ollama 3B-13B, Fireworks Llama 8B | 80%+ of execution | $0-0.0005/1k tok |
| **Architect** | Tier 3 | Claude/Gemini | Planning only (~5% queries) | $0.012/1k tok |
| **Advisor** | Tier 3 | Claude/Gemini | Review only (~5% queries) | $0.012/1k tok |
| **Vision** | Tier 2 | Ollama Vision 70B | Screenshot analysis | $0 (local) |
| **Batch** | Tier 4 | Self-hosted GPU | ‚â•50 ops if cost-effective | Variable |

**Target Distribution** (v4.1):
- Tier 0: 45% of queries (up from 40%)
- Tier 1: 35% of queries (up from 30%)
- Tier 2: 5% of queries (unchanged)
- Tier 3: 13% of queries (down from 20%)
- Tier 4: 2% of queries (unchanged)

**Economics**:
```
v4.0 Baseline (100 tasks):
- Tier 0: 40 √ó $0 = $0
- Tier 1: 30 √ó $0.10 = $3.00
- Tier 2: 5 √ó $0 = $0
- Tier 3: 23 √ó $0.50 = $11.50
- Tier 4: 2 √ó $0.30 = $0.60
Total: $15.10/month

v4.1 Open-Source First (100 tasks):
- Tier 0: 45 √ó $0 = $0
- Tier 1: 35 √ó $0.10 = $3.50
- Tier 2: 5 √ó $0 = $0
- Tier 3: 15 √ó $0.50 = $7.50
- Tier 4: 5 √ó $0.30 = $1.50 (allow more batch if cost-effective)
Total: $12.50/month (17% further savings)

v4.1 Privacy Mode (100 tasks):
- Tier 0: 100 √ó $0 = $0
- VPS: $75/month (fixed)
Total: $75/month fixed (0 variable API cost)
```

**Key Principle**: Premium models create plans, open-source models execute plans. This is the **architect/executor pattern at scale**.

---

### 2. Privacy Mode & Data Sovereignty

**Problem**: Sensitive codebases/data cannot be sent to external APIs. GDPR/HIPAA compliance requires on-premises processing.

**Solution**: Privacy Mode routes ALL queries to Tier 0/2 (local-only). No external API calls.

**Privacy Mode Behavior**:

| Tier | Privacy OFF | Privacy ON |
|------|-------------|------------|
| Tier 0 | Ollama 3B-13B (local) | ‚úÖ Ollama 3B-13B (local) |
| Tier 1 | Fireworks/Together (API) | ‚ùå BLOCKED ‚Üí Fallback to Tier 0 (13B) |
| Tier 2 | Ollama Vision 70B (local) | ‚úÖ Ollama Vision 70B (local) |
| Tier 3 | Claude/Gemini (API) | ‚ùå BLOCKED ‚Üí Fallback to Tier 0 (70B) |
| Tier 4 | RunPod/Salad (cloud GPU) | ‚ùå BLOCKED ‚Üí Local processing or error |

**Routing with Privacy Mode**:
```javascript
function routeWithPrivacy(task, privacyMode) {
  const baseRouting = routeTask(task);  // Normal tier selection

  if (privacyMode && baseRouting.tier >= 1 && baseRouting.tier !== 2) {
    // Privacy mode: Fallback external tiers to local equivalents
    if (baseRouting.tier === 1) {
      // Tier 1 ‚Üí Tier 0 with larger local model
      return {
        tier: 0,
        model: 'ollama/llama3.2:13b',
        reason: 'Privacy mode: Using local 13B instead of Fireworks API'
      };
    }
    if (baseRouting.tier === 3) {
      // Tier 3 ‚Üí Tier 0 with largest local model
      return {
        tier: 0,
        model: 'ollama/llama3.1:70b',
        reason: 'Privacy mode: Using local 70B instead of Claude/Gemini'
      };
    }
    if (baseRouting.tier === 4) {
      // Tier 4 ‚Üí Reject or use local batch processing
      throw new Error('Privacy mode: Batch GPU operations not available. Use local processing or disable privacy mode.');
    }
  }

  return baseRouting;
}
```

**Quality Trade-offs** (User-Acknowledged):
- Complex planning uses Tier 0 (70B local) instead of Tier 3 (Claude/Gemini)
- Quality may be 10-15% lower for complex reasoning tasks
- User explicitly accepts trade-off for privacy guarantee
- UI shows warning before enabling privacy mode

**Benefits**:
- ‚úÖ Complete data privacy (GDPR/HIPAA compliant)
- ‚úÖ Fixed cost ($75/month VPS only)
- ‚úÖ No variable API charges
- ‚úÖ Future-proof for home hardware deployment

**UI Indication**:
- Privacy ON: Green lock icon üîí + "All data stays local"
- Privacy OFF: Orange shield icon üõ°Ô∏è + "Using external APIs"
- Cost display: "Fixed $75/mo" vs "Variable API cost"

---

### 3. RAG Context Optimization (Anti-Hallucination)

**Problem**:
- Claude has narrow context (200k tokens, $3/M input) vs Gemini wide context (2M tokens, $1.25/M input)
- Large context increases hallucination risk
- Premium API costs scale with context size
- Unfocused context degrades quality

**Solution**: Optimize RAG retrieval for premium model context windows. Use Tier 0 for context compression.

**Context Budgets**:
- **Claude**: <8k tokens (stay far below 200k limit)
- **Gemini**: <32k tokens (stay far below 2M limit)
- **General rule**: Use 5-10% of max context window for quality

**Context Compression Pattern**:
```javascript
async function compressContext(rawContext, task) {
  if (rawContext.length < 8000) {
    return rawContext;  // No compression needed
  }

  // Use Tier 0 to compress
  const compressed = await callLLM({
    tier: 0,
    model: 'fast_filter',
    prompt: `Extract ONLY the code/content relevant to: "${task}"\n\nContext:\n${rawContext}\n\nReturn compressed version (max 7000 tokens).`
  });

  // Log compression ratio
  logMetric('context_compression_ratio', rawContext.length / compressed.length);

  return compressed;
}

// Use compressed context with architect
const plan = await callLLM({
  tier: 3,
  model: 'architect',
  prompt: `Task: ${task}\n\nRelevant context:\n${compressedContext}\n\nCreate plan.`
});
```

**Economics**:
```
Without Compression:
- Context: 50k tokens ‚Üí Claude ($0.15 input) ‚Üí Total $0.21

With Tier 0 Compression:
- Compression: 50k tokens ‚Üí Tier 0 ($0) ‚Üí 8k tokens
- Planning: 8k tokens ‚Üí Claude ($0.024 input) ‚Üí Total $0.034
- Savings: 84% per complex query
```

**RAG Library Integration**:
- **Primary**: LlamaIndex (Python service, HTTP API)
- **Fallback**: LangChain if LlamaIndex unavailable
- **Managed option**: Google Vertex AI RAG ($0.002 per 1k queries)
- **Storage**: Qdrant vector database (self-hosted)

**Coder Agent RAG Requirements**:
- Chunking: AST boundaries (functions/classes, not fixed 512-token chunks)
- Embedding: Local open-source (all-MiniLM-L6-v2, 384 dim)
- Retrieval: Top-K=5-10, rerank with Tier 0
- Context budget: <8k for Claude, <32k for Gemini
- Compression: If >8k, use Tier 0 to extract key snippets

**Web Agent RAG Requirements**:
- Chunking: Semantic blocks (headers, paragraphs, tables)
- Embedding: Same as Coder (consistency)
- Retrieval: Top-K=3-5, prioritize recent content
- Context budget: <5k for report generation
- Cache: 7 days in Qdrant (avoid re-scraping)

**Google Vertex AI RAG** (Optional):
```javascript
// For Gemini users: Use Google's managed RAG
const ragResult = await fetch('https://discoveryengine.googleapis.com/v1/...', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${GOOGLE_API_KEY}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    query: task,
    pageSize: 5,
    queryExpansionSpec: { condition: 'AUTO' }
  })
});

// Cost: $0.002 per 1000 queries (very cheap)
// Benefit: Optimized for Gemini's 2M context window
```

---

### 4. Web Agent Privacy & Performance

**Problem**: Per-browser implementations have terrible performance and privacy (tracking, fingerprinting, resource leaks).

**Solution**: Unified Playwright-based architecture with privacy-first design.

**Privacy Hardening**:

1. **Single Browser Engine**: Chromium only (consistent, lightweight)

2. **Disable Tracking**:
   - `--disable-sync --disable-background-networking`
   - Block ads/trackers using uBlock Origin filters
   - DNS-over-HTTPS to prevent ISP tracking

3. **Fingerprint Randomization**:
   - Rotate user agents, viewport sizes, timezones
   - No persistent profile (fresh context per session)
   - Deny all permissions (geolocation, notifications, camera)

4. **Resource Optimization**:
   - Headless by default (40-50% faster)
   - Block images/fonts when not needed
   - Connection pooling (reuse browser instances)
   - Auto-restart after 100 pages or 2GB RAM

**Enhanced Playwright Service**:
```javascript
// Hardened browser launch config
const browser = await chromium.launch({
  headless: true,
  args: [
    '--no-sandbox',
    '--disable-setuid-sandbox',
    '--disable-dev-shm-usage',  // Prevent crashes
    '--disable-gpu',
    '--disable-sync',
    '--disable-background-networking',
    '--disable-extensions',
    '--metrics-recording-only',
    '--mute-audio',
    '--no-first-run',
    '--blink-settings=imagesEnabled=false'  // Conditional
  ]
});

// Privacy-hardened context
const context = await browser.newContext({
  viewport: randomizeViewport(),  // Avoid fingerprinting
  userAgent: randomizeUserAgent(),
  permissions: [],  // Deny all
  ignoreHTTPSErrors: false,  // Enforce HTTPS
  extraHTTPHeaders: {
    'DNT': '1',  // Do Not Track
    'Sec-GPC': '1'  // Global Privacy Control
  }
});

// Block unnecessary resources
await context.route('**/*', (route) => {
  const resourceType = route.request().resourceType();
  if (['image', 'media', 'font'].includes(resourceType) && !task.requiresVisuals) {
    route.abort();
  } else {
    route.continue();
  }
});
```

**Performance Gains**:
- Headless: 40-50% faster than headed mode
- Resource blocking: 30-40% faster page loads (when images not needed)
- Connection pooling: 5 concurrent contexts (5x throughput)
- Memory limits: Auto-restart prevents leaks

---

### 5. Web Chat UI/UX - Cost Transparency

**Problem**: Users don't understand costs until after execution. No visibility into tier routing or budget consumption.

**Solution**: Real-time cost tracking with pre-prompt estimates, privacy toggle, and cost analytics dashboard.

**UI Components**:

**1. Header Controls**:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [Privacy: ON üîí]  [Agent: Coder üíª]  [Multimodal: OFF üëÅÔ∏è]  ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ Budget: $6.23 / $50.00  [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] 12%             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**2. Pre-Prompt Cost Estimate**:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Estimated cost: $0.08 - $0.15                                ‚îÇ
‚îÇ Breakdown:                                                    ‚îÇ
‚îÇ   ‚Ä¢ Planning (Tier 3): ~$0.06                                ‚îÇ
‚îÇ   ‚Ä¢ Execution (Tier 1): ~$0.04 (8 subtasks)                 ‚îÇ
‚îÇ   ‚Ä¢ Review (Tier 3): ~$0.05                                  ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ [Privacy: OFF] Switch to Privacy mode: ~$0 (local Tier 0)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**3. Real-Time Execution Tracking**:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Phase 2: Execution (5/8 subtasks) ‚è≥         Cost: $0.03      ‚îÇ
‚îÇ   ‚Ä¢ Find auth files (Tier 0) - $0                           ‚îÇ
‚îÇ   ‚Ä¢ Generate JWT utils (Tier 1) - $0.02                     ‚îÇ
‚îÇ   ‚Ä¢ Testing endpoints... ‚è≥                                   ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ Total so far: $0.09 / $0.15 est             [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë]    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**4. Cost Analytics Dashboard**:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ By Tier:                                                     ‚îÇ
‚îÇ   Tier 0 (Local):      45% tasks  ‚îÇ $0.00   ‚îÇ ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚îÇ
‚îÇ   Tier 1 (Fireworks):  35% tasks  ‚îÇ $3.50   ‚îÇ ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë  ‚îÇ
‚îÇ   Tier 3 (Claude):     13% tasks  ‚îÇ $7.50   ‚îÇ ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ Top Cost Savers:                                             ‚îÇ
‚îÇ   ‚Ä¢ Architect/Executor: Saved $15.20 (60%)                   ‚îÇ
‚îÇ   ‚Ä¢ Privacy Mode:       Saved $12.40 (45 tasks local)        ‚îÇ
‚îÇ   ‚Ä¢ Context Compression: Saved $3.10 (84% per query)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Implementation**:
- Real-time WebSocket updates during execution
- Debounced pre-prompt estimate (500ms after typing stops)
- Persistent settings (privacy mode) in localStorage
- Mobile-responsive (dashboard collapses to drawer)
- Accessibility (ARIA labels, keyboard nav, screen reader)

---

## New Functional Requirements

### Privacy Mode (FR-121 to FR-130)

**FR-121**: System MUST support privacy mode toggle in web chat header
**FR-122**: Privacy mode ON MUST block ALL external API calls (Tier 1, 3, 4)
**FR-123**: Privacy mode ON MUST route Tier 1 queries to Tier 0 (13B local)
**FR-124**: Privacy mode ON MUST route Tier 3 queries to Tier 0 (70B local)
**FR-125**: Privacy mode toggle MUST show confirmation dialog explaining trade-offs
**FR-126**: Privacy mode ON MUST display green lock icon üîí + "All data stays local"
**FR-127**: Privacy mode OFF MUST display orange shield icon üõ°Ô∏è + "Using external APIs"
**FR-128**: Privacy mode preference MUST persist in browser localStorage
**FR-129**: Cost display MUST show "Fixed $75/mo" when privacy ON
**FR-130**: System MUST log privacy mode status in execution metadata

### RAG Context Optimization (FR-131 to FR-140)

**FR-131**: Context retrieval MUST compress if >8k tokens before Tier 3 calls
**FR-132**: Context compression MUST use Tier 0 model (not Tier 3)
**FR-133**: System MUST log compression ratio for monitoring
**FR-134**: Coder Agent MUST chunk code at AST boundaries (functions/classes)
**FR-135**: Web Agent MUST chunk content at semantic blocks (headers/paragraphs)
**FR-136**: Embedding generation MUST use local model (all-MiniLM-L6-v2)
**FR-137**: RAG retrieval MUST use Top-K=5-10 for code, K=3-5 for web
**FR-138**: System MUST support Google Vertex AI RAG as optional provider
**FR-139**: Context budget MUST be <8k for Claude, <32k for Gemini
**FR-140**: System MUST rerank RAG results using Tier 0 before final selection

### Web Agent Privacy & Performance (FR-141 to FR-150)

**FR-141**: Playwright service MUST use Chromium only (single browser engine)
**FR-142**: Browser launch MUST include privacy flags (--disable-sync, --disable-background-networking)
**FR-143**: Browser context MUST randomize viewport, user agent, timezone
**FR-144**: Browser context MUST deny all permissions (geolocation, notifications, camera)
**FR-145**: Browser MUST block ads/trackers using route interception
**FR-146**: Browser MUST block images/fonts when task doesn't require visuals
**FR-147**: Browser instances MUST auto-restart after 100 pages or 2GB RAM
**FR-148**: Browser sessions MUST close after 5 min idle (auto-cleanup)
**FR-149**: Browser MUST support up to 5 concurrent contexts
**FR-150**: Playwright service MUST expose /health endpoint for monitoring

### Cost Transparency UI (FR-151 to FR-165)

**FR-151**: Web chat MUST show pre-prompt cost estimate BEFORE sending
**FR-152**: Pre-prompt estimate MUST update in real-time (debounced 500ms)
**FR-153**: Pre-prompt estimate MUST show cost range (min/max)
**FR-154**: Pre-prompt estimate MUST show privacy mode cost comparison
**FR-155**: Execution tracking MUST show real-time cost per phase
**FR-156**: Execution tracking MUST show tier used + model name per step
**FR-157**: Execution tracking MUST show progress bar vs estimated cost
**FR-158**: Execution tracking MUST warn if exceeds estimate by >20%
**FR-159**: Post-execution summary MUST show total cost with breakdown
**FR-160**: Post-execution summary MUST show token counts (in/out/total)
**FR-161**: Cost dashboard MUST show tier distribution (% tasks per tier)
**FR-162**: Cost dashboard MUST show agent distribution (Coder vs Web)
**FR-163**: Cost dashboard MUST calculate and display cost savers
**FR-164**: Cost dashboard MUST calculate burn rate and project monthly cost
**FR-165**: Cost dashboard MUST support CSV export

---

## Updated Success Criteria

**Cost Savings** (v4.1):
- 84-88% savings vs naive all-Tier-3 routing (maintained from v4.0)
- Privacy mode: 100% savings on API costs ($0 variable + $75 VPS fixed)
- Context compression: 84% savings per complex query
- Open-source execution: 80%+ queries on Tier 0/1

**Performance**:
- Pre-prompt estimate: <1s to calculate and display
- Web Agent (privacy mode): 40-50% faster with resource blocking
- RAG context compression: <2s for 50k ‚Üí 8k tokens
- Cost tracking accuracy: <5% variance from actual

**Privacy**:
- Privacy mode: 0 external API calls when enabled
- Web Agent: No persistent browser profile, no tracking
- Fingerprint randomization: Pass browser fingerprinting tests
- GDPR/HIPAA compliance: All data on-premises when privacy ON

**Quality**:
- Hallucination rate: <5% with optimized RAG context
- Privacy mode quality: 85-90% of privacy-OFF quality (acceptable trade-off)
- User satisfaction: >80% find cost transparency helpful

---

## Migration Path from v4.0 to v4.1

1. **Constitution**: Updated with 3 new principles (X, XI, XII ‚Üí now XIII)
2. **Workflows**: Add privacy mode routing logic to 005-tier-routing.json
3. **Playwright Service**: Update service.js with privacy hardening
4. **Web Chat UI**: Implement cost tracking components (Flowise customization)
5. **RAG Service**: Add LlamaIndex integration + context compression
6. **Budget Check**: No changes (privacy mode uses existing Tier 0 tracking)

**Breaking Changes**: None - v4.1 is backward compatible with v4.0 workflows

---

## Implementation Checklist

- [x] Update constitution with open-source first principle (Principle II)
- [x] Add Privacy Mode principle (Principle XI)
- [x] Add RAG Context Optimization principle (Principle X)
- [x] Add Web Agent Privacy & Performance requirements (Principle XII)
- [x] Add Web Chat UI/UX requirements (Principle XIII)
- [ ] Update 005-tier-routing.json with privacy mode logic
- [ ] Update playwright/service.js with privacy hardening
- [ ] Create web chat UI mockups (Flowise customization)
- [ ] Implement LlamaIndex service with context compression
- [ ] Add Google Vertex AI RAG integration (optional)
- [ ] Update README v4.0 with v4.1 refinements
- [ ] Create v4.1 migration guide
- [ ] Update cost projections with new distribution

---

## Document Version
**Version**: 4.1.0
**Parent**: v4.0.0
**Last Updated**: 2025-11-18
**Status**: Ready for implementation
**Breaking Changes**: No (backward compatible)
